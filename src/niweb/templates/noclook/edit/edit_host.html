{% extends "noclook/edit/base_edit.html" %}

{% block js %}
{{ block.super }}
{% load niweb_tags %}
<script language="javascript" type="text/javascript" src="{{ STATIC_URL }}js/jquery/jquery.jCombo.js"></script>
<script language="javascript" type="text/javascript" src="{{ STATIC_URL }}js/jquery/jquery.jeditable.mini.js"></script>
<script language="javascript" type="text/javascript" src="{{ STATIC_URL }}js/jquery/jquery.json-2.4.min.js"></script>
<script type="text/javascript">
$(document).ready(
    function(){
        // Modal delete object confirm
        $("#dialog-object-confirm").dialog({
          modal: true,
                bgiframe: true,
                width: 500,
                height: 200,
          autoOpen: false
          });

        $("#object-confirm").click(function(e) {
            e.preventDefault();
            var theHREF = $(this).attr("href");

            $("#dialog-object-confirm").dialog('option', 'buttons', {
                    "Confirm" : function() {
                        window.location.href = theHREF;
                        },
                    "Cancel" : function() {
                        $(this).dialog("close");
                        }
                    });

            $("#dialog-object-confirm").dialog("open");
        });
        // Populate first level combo box
        $.getJSON('/formdata/site/', function(data) {
            $('#level0').append($('<option>').val("0").text("-- Please Select --"));
            $.each(data, function(key, tuple) {
                $('#level0').append($('<option>').val(tuple[0]).text(tuple[1]));
            });
        });
        $('#level0').on('change', function() {
            $("#id_relationship_location").val($(this).val());
        });
        // Hook lower level combo boxes up to their parent
        $("#level1").jCombo("/formdata/{id}/children/rack/", {
                        parent: "#level0",
                        end_value_field: "#id_relationship_location"
                    });
        // Modal delete connection confirm
        $("#dialog-user-confirm").dialog({
            modal: true,
            bgiframe: true,
            width: 500,
            height: 200,
            autoOpen: false
        });

        $("a.user-confirm").click(function(e) {
            e.preventDefault();
            var theHREF = $(this).attr("href");


            $("#dialog-user-confirm").dialog('option', 'buttons', {
                "Confirm" : function() {
                    window.location.href = theHREF;
                },
                "Cancel" : function() {
                    $(this).dialog("close");
                }
            });

            $("#dialog-user-confirm").dialog("open");

        });
        // Depends on //
        // Populate first level combo box
        var categories = [
            ['service', 'Services'],
        ];
        $('#categoryA').append($('<option>').val("0").text("-- Please Select --"));
        $.each(categories, function(key, tuple) {
            $('#categoryA').append($('<option>').val(tuple[0]).text(tuple[1]));
        });
        // Hook lower level combo boxes up to their parent
        $("#level0A").jCombo("/formdata/{id}/", {
            parent: "#categoryA",
            end_value_field: "#id_relationship_depends_on"
        });
        $("#level1A").jCombo("/formdata/{id}/children/", {
            parent: "#level0A",
            end_value_field: "#id_relationship_depends_on"
        });
        $("#level2A").jCombo("/formdata/{id}/children/", {
            parent: "#level1A",
            end_value_field: "#id_relationship_depends_on"
        });
        $("#level3A").jCombo("/formdata/{id}/children/", {
            parent: "#level2A",
            end_value_field: "#id_relationship_depends_on"
        });
        $("#level4A").jCombo("/formdata/{id}/children/", {
            parent: "#level3A",
            end_value_field: "#id_relationship_depends_on"
        });
        // Accordion
        $(".edit-accordion").collapse()
    }
);
</script>
{% endblock %}

{% block content %}
{{ block.super }}
    <div id="dialog-user-confirm" title="Remove relationship?">
        <p><span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 20px 0;"></span>The relationship will be permanently deleted and cannot be recovered. Are you sure?</p>
    </div>
    <div id="operation-section">
        <h3>Operational information</h3>
        <div class="well">
            <label><strong>Description</strong></label>
            {{ form.description }}
            <span class="help-block">{{ form.description.help_text }}</span>
            <label><strong>Responsible</strong></label>
            {{ form.responsible_group }}
            <span class="help-block">{{ form.responsible_group.help_text }}</span>
            <label><strong>Support</strong></label>
            {{ form.support_group }}
            <span class="help-block">{{ form.support_group.help_text }}</span>
            <label><strong>Operational State</strong></label>
            {{ form.operational_state }}
            <span class="help-block">{{ form.operational_state.help_text }}</span>
            <label><strong>Security Class</strong></label>
            {{ form.security_class }}
            <label><strong>Security Comment</strong></label>
            {{ form.security_comment }}
        </div>
    </div>

    <div class="accordion" id="edit-accordion">
        <div class="accordion-group">
            <div class="accordion-heading">
                <a class="accordion-toggle" data-toggle="collapse" data-parent="#edit-accordion" href="#collapseOne">
                    Operational information (optional)
                </a>
            </div>
            <div id="collapseOne" class="accordion-body collapse" style="height: 0px; ">
                <div class="accordion-inner">
                    <label>Operating system</label>
                    {{ form.os }}
                    <span class="help-block">{{ form.os.help_text }}</span>
                    <label>Operating system version</label>
                    {{ form.os_version }}
                    <span class="help-block">{{ form.os_version.help_text }}</span>
                    {% if node_handle.node_meta_type == 'physical' %}
                        <label>Vendor</label>
                        {{ form.vendor }}
                        <span class="help-block">{{ form.vendor.help_text }}</span>
                        <label>Hardware model</label>
                        {{ form.model }}
                        <span class="help-block">{{ form.model.help_text }}</span>
                        <label>Service tag</label>
                        {{ form.service_tag }}
                        <span class="help-block">{{ form.service_tag.help_text }}</span>
                        <label>End of support</label>
                        {{ form.end_support }}
                        <span class="help-block">{{ form.end_support.help_text }}</span>
                        <script>
                            $(function() {
                                $( "#id_end_support" ).datepicker({ dateFormat: "yy-mm-dd" });
                            });
                        </script>
                    {% endif %}
                    <label>Contract number</label>
                    {{ form.contract_number }}
                    <span class="help-block">{{ form.contract_number.help_text }}</span>
                </div>
            </div>
        </div>
        <div class="accordion-group">
            <div class="accordion-heading">
                <a class="accordion-toggle" data-toggle="collapse" data-parent="#edit-accordion" href="#collapseTwo">
                    Location (optional)
                </a>
            </div>
            <div id="collapseTwo" class="accordion-body collapse" style="height: 0px; ">
                <div class="accordion-inner">
                    {% if node_handle.node_meta_type == 'logical' %}
                        <div class="alert alert-danger">Setting location will remove any dependencies for this host.</div>
                    {% endif %}
                    {% if location %}
                        <label>Current location</label>
                        {% load noclook_tags %}
                        {% for hit in location %}
                            <div class="row">
                                <div class="span3">
                                    <a href="{% noclook_node_to_url hit.loc %}">{{ hit.parent.name }} {{ hit.loc.name }}</a>
                                </div>
                                <div class="span1">
                                    <a href="relationship/{{ hit.loc_rel.id }}/delete" class="label label-important user-confirm">Delete</a>
                                </div>
                            </div>
                        {% endfor %}
                    {% endif %}
                    <label>Set location</label>
                    {{ form.relationship_location }}
                    <select class="stacked" name="level0" id="level0"></select>
                    <select class="stacked" name="level1" id="level1"></select>
                    <hr>
                    <label>Equipment height</label>
                    {{ form.rack_units }}
                    <span class="help-block">{{ form.rack_units.help_text }}</span>
                </div>
            </div>
        </div>
        <div class="accordion-group">
            <div class="accordion-heading">
                <a class="accordion-toggle" data-toggle="collapse" data-parent="#edit-accordion" href="#collapseThree">
                    Host depends on (optional)
                </a>
            </div>
            <div id="collapseThree" class="accordion-body collapse" style="height: 0px; ">

                <div class="accordion-inner">
                    {% if node_handle.node_meta_type == 'physical' %}
                        <div class="alert alert-danger">Setting dependencies will remove any location for this host.</div>
                    {% endif %}
                    {% if depends_on %}
                        {% load noclook_tags %}
                        <h4>Remove depends on relationship</h4>
                        {% for hit in depends_on %}
                            <div class="row">
                                <div class="span5">
                                    Depends on <a href="{% noclook_node_to_url hit.dep %}">{{ hit.grand_parent.name }} {% if hit.grand_parent %}{{ hit.parent.name }}.{{ hit.dep.name }}{% else %}{{ hit.parent.name }} {{ hit.dep.name }}{% endif %}</a>
                                </div>
                                <div class="span1">
                                    <a href="relationship/{{ hit.dep_rel.id }}/delete" class="label label-important user-confirm">Delete</a>
                                </div>
                            </div>
                        {% endfor %}
                        <hr>
                    {% endif %}
                    <h4>Add depends on relationship</h4>
                    <div class="span4">
                        {{ form.relationship_depends_on }}
                        <select class="stacked" name="categoryA" id="categoryA"></select>
                        <select class="stacked" name="level0A" id="level0A"></select>
                        <select class="stacked" name="level1A" id="level1A"></select>
                        <select class="stacked" name="level2A" id="level2A"></select>
                        <select class="stacked" name="level3A" id="level3A"></select>
                        <select class="stacked" name="level4A" id="level4A"></select>
                        <span class="help-block">Choose a service to depend the host on</span>
                        <br>
                        <br>
                    </div>
                </div>
            </div>
        </div>
        <div class="accordion-group">
            <div class="accordion-heading">
                <a class="accordion-toggle" data-toggle="collapse" data-parent="#edit-accordion" href="#collapseFour">
                    {% if node_handle.node_meta_type == 'logical' %}Host users (optional){% else %}Host owners (optional){% endif %}
                </a>
            </div>
            <div id="collapseFour" class="accordion-body collapse" style="height: 0px; ">
                <div class="accordion-inner">
                    {% if node_handle.node_meta_type == 'logical' %}
                        {% if user_relationships %}
                            {% load noclook_tags %}
                            <h4>Remove user</h4>
                            {% for rel in user_relationships %}
                                <div class="row">
                                    <div class="span5">
                                        <a href="{% noclook_node_to_url rel.start %}">{{ rel.start.name }}</a>
                                    </div>
                                    <div class="span1">
                                        <a href="relationship/{{ rel.id }}/delete" class="label label-important user-confirm">Delete</a>
                                    </div>
                                </div>
                            {% endfor %}
                        {% endif %}
                        <hr />
                        <h4>Add user</h4>
                        {{ form.relationship_user }}
                    {% else %}
                        {% if owner_relationships %}
                            {% load noclook_tags %}
                            <h4>Remove owner</h4>
                            {% for rel in owner_relationships %}
                                <div class="row">
                                    <div class="span5">
                                        <a href="{% noclook_node_to_url rel.start %}">{{ rel.start.name }}</a>
                                    </div>
                                    <div class="span1">
                                        <a href="relationship/{{ rel.id }}/delete" class="label label-important user-confirm">Delete</a>
                                    </div>
                                </div>
                            {% endfor %}
                        {% endif %}
                        <hr />
                        <h4>Add owner</h4>
                        {{ form.relationship_owner }}
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="accordion-group">
            <div class="accordion-heading">
                <a class="accordion-toggle" data-toggle="collapse" data-parent="#edit-accordion" href="#collapseFive">
                    Services
                </a>
            </div>
            <div id="collapseFive" class="accordion-body collapse" style="height: 0px; ">
                <div class="accordion-inner">
                    <label class="checkbox">
                        {{ form.services_locked }}
                        Services locked
                    </label>

                    <label class="checkbox">
                        {{ form.services_checked }}
                        All services below have been checked
                    </label>

                    {% if service_relationships %}
                        {% load noclook_tags %}
                        <h4>Remove service</h4>
                        {% for rel in service_relationships %}
                            <div class="row">
                                <div class="span2">
                                    {% if rel.rogue_port %}
                                        <i class="icon-exclamation-sign"></i>
                                    {% endif %}
                                    <a href="{% noclook_node_to_url rel.start %}">{{ rel.start.name }}</a>
                                </div>
                                <div class="span3">
                                    {{ rel.ip_address }} {{ rel.protocol }} {{ rel.port }}
                                </div>
                                <div class="span1">
                                    {% noclook_has_expired rel as expired %}
                                    {% if expired %}
                                        <span class="help-inline">(Expired)</span>
                                    {% endif %}
                                </div>
                                <div class="span1">
                                    <a href="relationship/{{ rel.id }}/delete" class="label label-important user-confirm">Delete</a>
                                </div>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="accordion-group">
            <div class="accordion-heading">
                <a class="accordion-toggle" data-toggle="collapse" data-parent="#edit-accordion" href="#collapseSix">
                    Convert host
                </a>
            </div>
            <div id="collapseSix" class="accordion-body collapse" style="height: 0px; ">
                <div class="accordion-inner">
                    <div class="alert alert-danger">
                        Warning. This action is not reversible.
                    </div>
                    <a class="btn btn-danger" href="edit/convert-to/switch/"><i class="icon-exclamation-sign icon-white"></i> Convert to switch</a>
                    <a class="btn btn-danger" href="edit/convert-to/firewall/"><i class="icon-exclamation-sign icon-white"></i> Convert to firewall</a>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
